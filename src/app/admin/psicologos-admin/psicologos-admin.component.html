<!-- aplicacionWeb/src/app/admin/psicologos-admin/psicologos-admin.component.html -->
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">
          <i class="bi bi-people-fill me-2"></i>
          Gestión de Psicólogos
        </h2>
        <div class="badge bg-info">
          Total: {{ psicologos.length }} | Filtrados: {{ psicologosFiltrados.length }}
        </div>
      </div>

      <!-- Filtros -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-funnel me-2"></i>Filtros
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            
            <!-- Filtro por nombre -->
            <div class="col-md-4">
              <label class="form-label">Buscar por nombre:</label>
              <input 
                type="text" 
                class="form-control" 
                placeholder="Nombre, apellido..."
                [(ngModel)]="filtroNombre"
                (input)="aplicarFiltros()"
              >
            </div>

            <!-- Filtro por estado de cuenta -->
            <div class="col-md-4">
              <label class="form-label">Estado de cuenta:</label>
              <select 
                class="form-select" 
                [(ngModel)]="filtroEstado"
                (change)="aplicarFiltros()"
              >
                <option value="todos">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Inactivos</option>
              </select>
            </div>

            <!-- Filtro por cédula -->
            <div class="col-md-4">
              <label class="form-label">Estado de cédula:</label>
              <select 
                class="form-select" 
                [(ngModel)]="filtroCedula"
                (change)="aplicarFiltros()"
              >
                <option value="todos">Todas las cédulas</option>
                <option value="verificada">Verificadas</option>
                <option value="no_verificada">No verificadas</option>
              </select>
            </div>

          </div>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando psicólogos...</p>
      </div>

      <!-- Tabla de psicólogos -->
      <div *ngIf="!cargando" class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Lista de Psicólogos Registrados</h5>
        </div>
        <div class="card-body p-0">
          
          <!-- Tabla responsive -->
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Nombre Completo</th>
                  <th>Correo</th>
                  <th>Cédula</th>
                  <th>Estado Cédula</th>
                  <th>Estado Cuenta</th>
                  <th>Especialidad</th>
                  <th>Fecha Registro</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr 
                  *ngFor="let psicologo of psicologosFiltrados; let i = index"
                  [ngClass]="getClaseFilaPsicologo(psicologo)"
                  style="cursor: pointer;"
                  (click)="seleccionarPsicologo(psicologo)"
                >
                  <td class="fw-bold">{{ psicologo.id_psicologo }}</td>
                  
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-circle me-2">
                        {{ psicologo.nombre.charAt(0) }}{{ psicologo.apellidoPaterno.charAt(0) }}
                      </div>
                      <div>
                        <div class="fw-semibold">
                          {{ psicologo.nombre }} {{ psicologo.apellidoPaterno }} {{ psicologo.apellidoMaterno }}
                        </div>
                        <small class="text-muted">ID: {{ psicologo.codigo_vinculacion }}</small>
                      </div>
                    </div>
                  </td>

                  <td>
                    <div>{{ psicologo.correo }}</div>
                    <small class="text-muted">{{ psicologo.telefono }}</small>
                  </td>

                  <td class="fw-bold">{{ psicologo.cedula }}</td>

                  <td>
                    <span 
                      class="badge"
                      [ngClass]="{
                        'bg-success': psicologo.cedula_validada,
                        'bg-warning text-dark': !psicologo.cedula_validada
                      }"
                    >
                      <i 
                        class="bi me-1"
                        [ngClass]="{
                          'bi-check-circle': psicologo.cedula_validada,
                          'bi-exclamation-triangle': !psicologo.cedula_validada
                        }"
                      ></i>
                      {{ getEstadoCedulaTexto(psicologo.cedula_validada) }}
                    </span>
                  </td>

                  <td>
                    <span 
                      class="badge"
                      [ngClass]="{
                        'bg-success': psicologo.status === 'activo',
                        'bg-danger': psicologo.status === 'inactivo'
                      }"
                    >
                      <i 
                        class="bi me-1"
                        [ngClass]="{
                          'bi-check-circle': psicologo.status === 'activo',
                          'bi-x-circle': psicologo.status === 'inactivo'
                        }"
                      ></i>
                      {{ psicologo.status | titlecase }}
                    </span>
                  </td>

                  <td>{{ psicologo.especialidad }}</td>

                  <td>
                    <small>{{ formatearFecha(psicologo.createdAt) }}</small>
                  </td>

                  <td>
                    <button 
                      class="btn btn-outline-primary btn-sm"
                      (click)="$event.stopPropagation(); seleccionarPsicologo(psicologo)"
                      title="Ver detalles"
                    >
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
                </tr>

                <!-- Empty state -->
                <tr *ngIf="psicologosFiltrados.length === 0">
                  <td colspan="9" class="text-center py-5">
                    <div class="text-muted">
                      <i class="bi bi-search fs-1"></i>
                      <p class="mt-2">No se encontraron psicólogos con los filtros aplicados</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal de detalles del psicólogo -->
<div 
  class="modal fade" 
  [class.show]="mostrarModal" 
  [style.display]="mostrarModal ? 'block' : 'none'" 
  tabindex="-1" 
  *ngIf="mostrarModal && psicologoSeleccionado"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Header del modal -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-person-circle me-2"></i>
          Detalles del Psicólogo
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <!-- Body del modal -->
      <div class="modal-body">
        
        <!-- Información básica -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-primary mb-3">
              <i class="bi bi-person-vcard me-2"></i>Información Personal
            </h6>
            <div class="info-item">
              <strong>Nombre completo:</strong>
              <span>{{ psicologoSeleccionado.nombre }} {{ psicologoSeleccionado.apellidoPaterno }} {{ psicologoSeleccionado.apellidoMaterno }}</span>
            </div>
            <div class="info-item">
              <strong>Fecha de nacimiento:</strong>
              <span>{{ formatearFecha(psicologoSeleccionado.fecha_nacimiento) }}</span>
            </div>
            <div class="info-item">
              <strong>Especialidad:</strong>
              <span>{{ psicologoSeleccionado.especialidad }}</span>
            </div>
          </div>

          <div class="col-md-6">
            <h6 class="text-primary mb-3">
              <i class="bi bi-envelope me-2"></i>Información de Contacto
            </h6>
            <div class="info-item">
              <strong>Correo electrónico:</strong>
              <span>{{ psicologoSeleccionado.correo }}</span>
            </div>
            <div class="info-item">
              <strong>Teléfono:</strong>
              <span>{{ psicologoSeleccionado.telefono }}</span>
            </div>
            <div class="info-item">
              <strong>Código de vinculación:</strong>
              <span class="badge bg-secondary">{{ psicologoSeleccionado.codigo_vinculacion }}</span>
            </div>
          </div>
        </div>

        <!-- Información profesional -->
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">
              <i class="bi bi-award me-2"></i>Información Profesional
            </h6>
            <div class="row">
              <div class="col-md-4">
                <div class="info-item">
                  <strong>Cédula profesional:</strong>
                  <span class="fw-bold">{{ psicologoSeleccionado.cedula }}</span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <strong>Estado de cédula:</strong>
                  <span 
                    class="badge"
                    [ngClass]="{
                      'bg-success': psicologoSeleccionado.cedula_validada,
                      'bg-warning text-dark': !psicologoSeleccionado.cedula_validada
                    }"
                  >
                    {{ getEstadoCedulaTexto(psicologoSeleccionado.cedula_validada) }}
                  </span>
                </div>
              </div>
              <div class="col-md-4">
                <div class="info-item">
                  <strong>Estado de cuenta:</strong>
                  <span 
                    class="badge"
                    [ngClass]="{
                      'bg-success': psicologoSeleccionado.status === 'activo',
                      'bg-danger': psicologoSeleccionado.status === 'inactivo'
                    }"
                  >
                    {{ psicologoSeleccionado.status | titlecase }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fecha de registro -->
        <div class="row">
          <div class="col-12">
            <h6 class="text-primary mb-3">
              <i class="bi bi-calendar-event me-2"></i>Información del Sistema
            </h6>
            <div class="info-item">
              <strong>Fecha de registro:</strong>
              <span>{{ formatearFecha(psicologoSeleccionado.createdAt) }}</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Footer del modal con acciones -->
      <!-- Sección del modal - Footer corregido -->
  <div class="modal-footer">
    <div class="d-flex flex-wrap gap-2 w-100">
      
      <!-- ✅ BOTÓN CORREGIDO: Validar cédula con API -->
      <button 
        class="btn btn-warning"
        (click)="validarCedulaConAPI(psicologoSeleccionado)"
        [disabled]="validandoCedula || psicologoSeleccionado.cedula_validada"
        title="Validar cédula profesional automáticamente"
      >
        <span *ngIf="validandoCedula" class="spinner-border spinner-border-sm me-2"></span>
        <i *ngIf="!validandoCedula" class="bi bi-patch-check me-2"></i>
        {{ psicologoSeleccionado.cedula_validada ? 'Cédula Validada' : 'Validar con API' }}
      </button>

      <!-- Botón para abrir consulta oficial -->
      <button 
        class="btn btn-info"
        (click)="abrirConsultaOficial()" 
        title="Consultar cédulas en sitio oficial SEP"
      >
        <i class="bi bi-search me-2"></i>Ver en SEP
      </button>

      <!-- Cambiar estado de cuenta -->
      <button 
        *ngIf="psicologoSeleccionado.status === 'activo'"
        class="btn btn-outline-danger"
        (click)="cambiarEstadoCuenta(psicologoSeleccionado, 'inactivo')"
        title="Inhabilitar cuenta"
      >
        <i class="bi bi-x-circle me-2"></i>Inhabilitar
      </button>

      <button 
        *ngIf="psicologoSeleccionado.status === 'inactivo'"
        class="btn btn-outline-success"
        (click)="cambiarEstadoCuenta(psicologoSeleccionado, 'activo')"
        title="Habilitar cuenta"
      >
        <i class="bi bi-check-circle me-2"></i>Habilitar
      </button>

      <!-- Eliminar cuenta -->
      <button 
        class="btn btn-outline-danger"
        (click)="eliminarCuenta(psicologoSeleccionado)"
        title="Eliminar cuenta permanentemente"
      >
        <i class="bi bi-trash me-2"></i>Eliminar
      </button>

      <!-- Cerrar modal -->
      <button class="btn btn-secondary ms-auto" (click)="cerrarModal()">
        Cerrar
      </button>
      
    </div>
  </div>

    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div 
  class="modal-backdrop fade show" 
  *ngIf="mostrarModal"
  (click)="cerrarModal()"
></div>
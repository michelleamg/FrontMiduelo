<!-- aplicacionWeb/src/app/psicologo/chat/chat.component.html -->
<div class="chat-container">
  <!-- Panel Izquierdo: Lista de Chats -->
  <div class="chat-sidebar">
    <!-- Header con búsqueda -->
    <div class="chat-header">
      <h4 class="mb-3">Chats</h4>
      <div class="search-container mb-3">
        <div class="input-group">
          <input 
            type="text" 
            class="form-control" 
            placeholder="Buscar por nombre o mensaje..."
            [(ngModel)]="terminoBusqueda"
            (input)="buscarChats()"
          >
          <button class="btn btn-outline-secondary" type="button">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
      <button 
        class="btn btn-primary w-100 mb-3" 
        (click)="abrirModalNuevoChat()"
      >
        <i class="bi bi-plus-circle"></i> Nuevo Chat
      </button>
    </div>

    <!-- Lista de Chats -->
    <div class="chat-list">
      <!-- Loading -->
      <div *ngIf="cargandoChats" class="text-center p-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </div>

      <!-- Lista -->
      <div 
        *ngFor="let chat of chats" 
        class="chat-item"
        [class.active]="chatActual?.id_chat === chat.id_chat"
        (click)="seleccionarChat(chat)"
      >
        <!-- Avatar -->
        <div class="chat-avatar">
          <div class="avatar-circle">
            {{ getNombreCompleto(chat).charAt(0).toUpperCase() }}
          </div>
        </div>

        <!-- Info del Chat -->
        <div class="chat-info">
          <div class="chat-name">
            {{ getNombreCompleto(chat) }}
          </div>
          <div class="chat-last-message" *ngIf="chat.ultimo_mensaje">
            <span class="message-sender" *ngIf="chat.ultimo_mensaje.remitente === 'psicologo'">
              Tú: 
            </span>
            {{ chat.ultimo_mensaje.contenido }}
          </div>
          <div class="chat-placeholder" *ngIf="!chat.ultimo_mensaje">
            Sin mensajes
          </div>
        </div>

        <!-- Metadata -->
        <div class="chat-meta">
          <div class="chat-time" *ngIf="chat.ultimo_mensaje">
            {{ formatearFecha(chat.ultimo_mensaje.fecha_envio) }}
          </div>
          <div 
            class="unread-badge" 
            *ngIf="chat.mensajes_no_leidos && chat.mensajes_no_leidos > 0"
          >
            {{ chat.mensajes_no_leidos }}
          </div>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="!cargandoChats && chats.length === 0" class="empty-state">
        <i class="bi bi-chat-dots text-muted"></i>
        <p class="text-muted mt-2">No hay chats disponibles</p>
        <button class="btn btn-outline-primary" (click)="abrirModalNuevoChat()">
          Crear primer chat
        </button>
      </div>
    </div>
  </div>

  <!-- Panel Derecho: Chat Activo -->
  <div class="chat-main">
    <!-- No hay chat seleccionado -->
    <div *ngIf="!chatActual" class="no-chat-selected">
      <i class="bi bi-chat-text text-muted"></i>
      <h5 class="text-muted mt-3">Selecciona un chat para comenzar</h5>
      <p class="text-muted">Elige una conversación de la lista o crea una nueva</p>
    </div>

    <!-- Chat Activo -->
    <div *ngIf="chatActual" class="chat-active">
      <!-- Header del Chat -->
      <div class="chat-active-header">
        <div class="d-flex align-items-center">
          <div class="chat-avatar me-3">
            <div class="avatar-circle">
              {{ getNombreCompleto(chatActual).charAt(0).toUpperCase() }}
            </div>
          </div>
          <div>
            <h5 class="mb-0">{{ getNombreCompleto(chatActual) }}</h5>
            <small class="text-muted">{{ chatActual.paciente?.email }}</small>
          </div>
        </div>
      </div>

      <!-- Área de Mensajes -->
      <div 
        class="messages-area" 
        #messagesContainer
      >
        <!-- Loading Mensajes -->
        <div *ngIf="cargandoMensajes" class="text-center p-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando mensajes...</span>
          </div>
        </div>

        <!-- Mensajes -->
        <div *ngFor="let mensaje of mensajes" class="message-wrapper">
          <div 
            class="message"
            [class.message-sent]="esMensajeMio(mensaje)"
            [class.message-received]="!esMensajeMio(mensaje)"
          >
            <div class="message-content">
              {{ mensaje.contenido }}
            </div>
            <div class="message-time">
              {{ formatearHora(mensaje.fecha_envio) }}
            </div>
          </div>
        </div>

        <!-- Placeholder si no hay mensajes -->
        <div *ngIf="!cargandoMensajes && mensajes.length === 0" class="no-messages">
          <p class="text-muted text-center">
            Inicia la conversación enviando un mensaje
          </p>
        </div>
      </div>

      <!-- Input para Nuevo Mensaje -->
      <div class="message-input-area">
        <div class="input-group">
          <textarea 
            class="form-control" 
            placeholder="Escribe un mensaje..."
            [(ngModel)]="nuevoMensaje"
            (keydown)="onEnterPress($event)"
            rows="1"
          ></textarea>
          <button 
            class="btn btn-primary" 
            type="button"
            (click)="enviarMensaje()"
            [disabled]="!nuevoMensaje.trim()"
          >
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Nuevo Chat -->
<div class="modal fade" [class.show]="mostrarModalNuevoChat" [style.display]="mostrarModalNuevoChat ? 'block' : 'none'" 
     tabindex="-1" *ngIf="mostrarModalNuevoChat">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo Chat</h5>
        <button type="button" class="btn-close" (click)="cerrarModalNuevoChat()"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Selecciona un paciente:</label>
        <select class="form-select" [(ngModel)]="pacienteSeleccionado">
          <option [value]="null">Selecciona un paciente</option>
          <option 
            *ngFor="let paciente of pacientesSinChat" 
            [value]="paciente.id_paciente"
          >
            {{ paciente.nombre }} {{ paciente.apellido_paterno }} {{ paciente.apellido_materno }}
          </option>
        </select>
        
        <div *ngIf="pacientesSinChat.length === 0" class="alert alert-info mt-3">
          Todos tus pacientes ya tienen un chat activo.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalNuevoChat()">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="crearNuevoChat()"
          [disabled]="!pacienteSeleccionado"
        >
          Crear Chat
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del Modal -->
<div 
  class="modal-backdrop fade show" 
  *ngIf="mostrarModalNuevoChat"
  (click)="cerrarModalNuevoChat()"
></div>